<!DOCTYPE html> 
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <title>WhyR?</title>


  <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
  <script type="text/javascript" src="pakiety.js"></script>
    <script type="text/javascript" src="warsztaty.js"></script>


<link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">


  <style type="text/css">

    svg {
       display: block;
       margin-left: auto;
       margin-right: auto;
       border: 1px solid black;
      
      }

  
.x.axis .domain {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

text {
  font-family: 'Roboto Condensed', sans-serif;
}


#tooltip { 
    position: absolute;  /* jest pozycjonowana pikselami ktore zostaly podane */  
    height: auto;
    width:  auto;       
    padding: 10px;       
    font: 12px sans-serif;  
    text-align: left;      
    background: white; /* tlo */
    border: 10px;    /* obramowanie */
    border-radius: 4px;    /* obramowanie zaokrąglone */ 
    box-shadow:  0px 0px 10px 2px rgba(0,0,0,0.57); 
    pointer-events: none;/*zeby nie reagował na najechanie na niego myszką, to co my robimy to tworzymy tooltipa i potem
    go ukrywamy lub nie, jest niewidoczny ale jest, wiec mozna na niego najechac myszka, jesli najedziemy na niego,
    to nie mamy dostepu do elementow pod nim, mozna by było po prostu tworzyc i usuwac go w .on */
    font-family: 'Roboto Condensed', sans-serif;
  }



text {
  font-family: 'Roboto Condensed', sans-serif;
}

  .warsztat_nazwa {
        font-size: 12.5px;
  }

 .link {
  fill: none;
  stroke: #000;
  stroke-opacity: .3;
  shape-rendering: auto;
}

.labelka, #przycisk{

  font-size: 12px;

}

.zajetosc text {
  stroke: none;
  fill: grey;
}


    </style>
     
</head>
<body>

<div id="chart">
   </div>

 <div id="chart0" >
   </div>

 <div id="chart1" >
   </div>

 <div id="chart2">
   </div>


<script type="text/javascript">




//********************************************************************************* USTAWIENIA OBSZARU RYSOWANIA

var margin = {top: 140, right: 60, bottom: 60, left: 60};

var width = 980 - margin.left - margin.right,
    height = 50 - margin.top - margin.bottom;

// CAŁA GRAFIKA
var svg=d3.select("#chart")  
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)

// OBSZAR WYKRESU
var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
        .attr( "xmlns",'xlink="http://www.w3.org/1999/xlink"')


//********************************************************************************* TYTUŁY, ŹRÓDŁO



// TYTUŁ I PODTYTUŁ
var tytulik = "WhyR:";
var zakladkiTytuly = ["ogólne", "warsztaty", "pakiety"]


var pasek = svg.append("g")
                 .attr("class", "tytuly")

pasek.append("text")
              .attr("x", margin.left)             
              .attr("y", (margin.top)*(1/4))
              .style("font-size", "28px")  
              .style("font-weight", "bold")  
              .text(tytulik);


var zakladki = pasek.selectAll(".zakladki text")
              .data(zakladkiTytuly)
              .enter()
              .append("text")
              .attr("x", function(d,i){return width/3*(i+1)})             
              .attr("y", (margin.top)*(1/4))
              .style("font-size", "26px")  
              .text(function(d){return d;});


zakladki.on("click",function(d){


    if( d == "ogólne" ){


        d3.select("#svg_chart1").remove()
        d3.select("#svg_chart2").remove()
         d3.select("#tooltip").remove()

        var c = d3.select("#svg_chart0");
        
        if(c[0][0] == null){

        //stworzWykresOgolny();

        }


    }
    else if( d == "warsztaty" ){

        d3.select("#svg_chart2").remove()
         d3.select("#svg_chart0").remove()
            d3.select("#tooltip").remove()


        var c = d3.select("#svg_chart1");
        
        if(c[0][0] == null){

        stworzWykresWarsztaty();

        }

    }

    else if( d == "pakiety" ){


        d3.select("#svg_chart1").remove()
         d3.select("#svg_chart0").remove()
            d3.select("#tooltip").remove()

        var c = d3.select("#svg_chart2");
        
        if(c[0][0] == null){

        stworzWykresPakiety();

        }
    }


})






stworzWykresPakiety = function(){
  var margin = {top: 140, right: 60, bottom: 60, left: 60};

var width = 980 - margin.left - margin.right,
    height = 560 - margin.top - margin.bottom;

// CAŁA GRAFIKA
var svg=d3.select("#chart2")  
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .attr("id", "svg_chart2")
// OBSZAR WYKRESU
var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
        .attr( "xmlns",'xlink="http://www.w3.org/1999/xlink"')


    // padding between nodes
 var   padding = 2,
   minRadius = 1,
    maxRadius = 80,
    numberOfNodes = dane.length;




//********************************************************************************* TYTUŁY, ŹRÓDŁO



// TYTUŁ I PODTYTUŁ
var tytulik = "Co piszczy na CRANie?";
var podtytulik = "Najpopularniejsze pakiety R-owe wśród uczestników konferencji";



var tytuly = svg.append("g")
                 .attr("class", "tytuly")

var tytul = tytuly.append("text")
              .attr("x", margin.left)             
              .attr("y", (margin.top)*(1/4))
              .style("font-size", "28px")  
              .text(tytulik);

var podtytul = tytuly.append("text")
              .attr("x", margin.left)             
              .attr("y", (margin.top)*(2/4))
              .style("font-size", "16px")  
              .text(podtytulik);

var zrodlo = tytuly.append("text")
              .attr("x", margin.left)             
              .attr("y", height+margin.top+ margin.bottom*(2/3))
              .style("font-size", "10px") 
              .text("Źródło: WhyR - ankiety, RDocumentation");

//********************************************************************************* SKALE


var loading = svg.append("text")
  .attr("x", ( width + margin.left + margin.right ) / 2)
  .attr("y", ( height + margin.top + margin.bottom ) / 2)
  .attr("dy", ".35em")
  .style("text-anchor", "middle")
  .text("Generowanie wykresu...");

var x = d3.scale.linear()
  .domain( [0, d3.max(dane, function(d){ return d.doswiadczenie_R_mean;})] )
  .range( [0, width ] );



var xAxis = d3.svg.axis()
  .scale(x);


  var skalaR = d3.scale.sqrt()
  skalaR.range([minRadius,  maxRadius]);

  skalaR.domain( [ 0,  d3.max(dane, function(d){ return d.Freq;}) ] ) 





// Create random node data.
var data = dane.map(function(d) {
  var value = d.doswiadczenie_R_mean,
      size =  skalaR(d.Freq),
       name = d.pakiety,
      datum = {value: value, size: size, name: name};
  return datum;
});


  
// Map the basic node data to d3-friendly format.
var nodes = data.map(function(node, index) {
  return {
    idealradius: node.size,
    radius: 0,
    // Give each node a random color.
    color: '#ff7f0e',
    // Set the node's gravitational centerpoint.
    idealcx: x(node.value),
    idealcy: height / 2,
    x: x(node.value),
    // Add some randomization to the placement;
    // nodes stacked on the same point can produce NaN errors.
    y: height / 2 + Math.random(),
    name: node.name
  };  
});

var force = d3.layout.force()
  .nodes(nodes)
  .size([width, height])
  .gravity(0)
  .charge(0)
  .on("tick", tick)
  .start();


/**
 * On a tick, apply custom gravity, collision detection, and node placement.
 */
function tick(e) {
  for ( i = 0; i < nodes.length; i++ ) {
    var node = nodes[i];
    /*
     * Animate the radius via the tick.
     *
     * Typically this would be performed as a transition on the SVG element itself,
     * but since this is a static force layout, we must perform it on the node.
     */
    node.radius = node.idealradius - node.idealradius * e.alpha * 10;
    node = gravity(.2 * e.alpha)(node);
    node = collide(.5)(node);
    node.cx = node.x;
    node.cy = node.y;
  }
}

/**
 * On a tick, move the node towards its desired position,
 * with a preference for accuracy of the node's x-axis placement
 * over smoothness of the clustering, which would produce inaccurate data presentation.
 */
function gravity(alpha) {
  return function(d) {
    d.y += (d.idealcy - d.y) * alpha;
    d.x += (d.idealcx - d.x) * alpha * 3;
    return d;
  };
}

/**
 * On a tick, resolve collisions between nodes.
 */
function collide(alpha) {
  var quadtree = d3.geom.quadtree(nodes);
  return function(d) {
    var r = d.radius + maxRadius + padding,
        nx1 = d.x - r,
        nx2 = d.x + r,
        ny1 = d.y - r,
        ny2 = d.y + r;
    quadtree.visit(function(quad, x1, y1, x2, y2) {
      if (quad.point && (quad.point !== d)) {
        var x = d.x - quad.point.x,
            y = d.y - quad.point.y,
            l = Math.sqrt(x * x + y * y),
            r = d.radius + quad.point.radius + padding;
        if (l < r) {
          l = (l - r) / l * alpha;
          d.x -= x *= l;
          d.y -= y *= l;
          quad.point.x += x;
          quad.point.y += y;
        }
      }
      return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
    });
    return d;
  };
}

/**
 * Run the force layout to compute where each node should be placed,
 * then replace the loading text with the graph.
 */
function renderGraph() {
  // Run the layout a fixed number of times.
  // The ideal number of times scales with graph complexity.
  // Of course, don't run too long—you'll hang the page!
  force.start();
  for (var i = 100; i > 0; --i) force.tick();
  force.stop();

  g.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," +  height  + ")")
    .call(xAxis);

     var tooltipki=d3.select("#chart2").append("div").attr("id", "tooltip").style("opacity",0)

  var circle = g.selectAll("circle")
    .data(nodes)
  .enter().append("circle")
    .style("fill", function(d) { return d.color; })
    .attr("cx", function(d) { return d.x} )
    .attr("cy", function(d) { return d.y} )
    .attr("r", function(d) { return d.radius} )
    .on("mouseover", function(d){


      tooltipki.html( "<b>" + d.name +"</b>" + "<br/>"

           )
      .style("left", (d3.event.pageX ) + "px") /* ustalamy pozycje elementu tam gdzie zostanie akcja podjeta */
      .style("top", (d3.event.pageY) + "px")
      .transition()
      .duration(300)
      .style("opacity",1);
    

      d3.select(this)
            .transition()
            .duration(300)
            .style("stroke-width", "3px");



      }

    )
.on("mouseout", function(d){

    
      d3.select(this)
        .transition()
        .duration(300)
        .style("stroke-width", "0.5px");

      tooltipki
      .transition()
      .duration(300)
      .style("opacity", 0);
              
 

      }
    );

  loading.remove();
}
// Use a timeout to allow the rest of the page to load first.
setTimeout(renderGraph, 0);

}


stworzWykresWarsztaty = function(){



// TYTUŁ I PODTYTUŁ
var tytulik = "Warsztaty";
var podtytulik = "Typowe ścieżki oraz profile uczestników warsztatów";

//********************************************************************************* USTAWIENIA OBSZARU RYSOWANIA

var margin = {top: 140, right: 60, bottom: 60, left: 60};

var width = 980 - margin.left - margin.right,
    height = 1620 - margin.top - margin.bottom;

// CAŁA GRAFIKA
var svg=d3.select("#chart1")  
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .attr("id", "svg_chart1")

// OBSZAR WYKRESU
var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
        .attr( "xmlns",'xlink="http://www.w3.org/1999/xlink"')



var ile_rano = dane.filter(function(d){ return d.sesja == "sesja poranna"; }).length

var paddingBox = 10; // miedzy rect w pionie
var heightBox = d3.min([(height-(ile_rano-1)*paddingBox)/9, 50]);
var heightBox2 =  150;
var paddingBlock = 150; // miedzy rect w poziomie
var widthBox = (width-paddingBlock)/2;
var paddingRect = 10; // w srodku rect

var dlugoscZajetosci = widthBox/2 // dlugosc maxymalna w pikselach paska zajetosci
var dlugoscStatystyki = widthBox*1/6 // dlugosc maxymalna w pikselach paska w histogramie
//********************************************************************************* SKALE

var warsztaciki = d3.nest()
                        .entries(dane)
                        .map(function(d){return d.warsztat;})

var skalaKolor = d3.scale.category10(); 

skalaKolor.domain(warsztaciki);



var skalaZajete = d3.scale.linear();
    skalaZajete.domain([0,20])
    skalaZajete.range([0, dlugoscZajetosci])

var skalaStatystyki = d3.scale.linear();
    skalaStatystyki.domain([0,100])
    skalaStatystyki.range([0, dlugoscStatystyki])


//********************************************************************************* TYTUŁY, ŹRÓDŁO

var tytuly = svg.append("g")
                 .attr("class", "tytuly")

var tytul = tytuly.append("text")
              .attr("x", margin.left)             
              .attr("y", (margin.top)*(1/4))
              .style("font-size", "28px")  
              .text(tytulik);

var podtytul = tytuly.append("text")
              .attr("x", margin.left)             
              .attr("y", (margin.top)*(2/4))
              .style("font-size", "16px")  
              .text(podtytulik);

var zrodlo = tytuly.append("text")
              .attr("x", margin.left)             
              .attr("y", height+margin.top+ margin.bottom*(2/3))
              .style("font-size", "10px") 
              .text("Źródło: WhyR - ankiety");


//********************************************************************************* TWORZENIE PROSTOKĄTA

//**************************************************************************** tworzenie stringa z _ zamiast spacji

var podkreslString = function(s){

        s = s.replace(/ę/ig,'e');
        s = s.replace(/ż/ig,'z');
        s = s.replace(/ó/ig,'o');
        s = s.replace(/ł/ig,'l');
        s = s.replace(/ć/ig,'c');
        s = s.replace(/ś/ig,'s');
        s = s.replace(/ź/ig,'z');
        s = s.replace(/ń/ig,'n');
        s = s.replace(/ą/ig,'a');
        s = s.replace(/:/ig,"");
        s = s.replace(/\./ig,"");
        s = s.replace(/\+/ig,"");
        s = s.replace(/\=/ig,"");
        s = s.replace(/\-/ig,"");
        s = s.replace(/\,/ig,"");
        s = s.split(' ').join("_");

    return s;
}



var sesja_rano = g.append("g").attr("class", "warsztaty rano")

    sesja_rano.append("text")
              .attr("x", widthBox/2)             
              .attr("y", -paddingBox*2)
              .text("sesja poranna")
              .style("text-anchor", "middle")
              .attr("class", "labelka")

 var   sesja_rano_grupy = sesja_rano.selectAll("g")
                      .data(dane
                        .filter(function(d){ return d.sesja == "sesja poranna"; })
                        .sort(function(x, y){
                                       return d3.descending(x.ile, y.ile);
                                    }))
                      .enter()
                      .append("g")
                      .attr("class", function(d){return podkreslString(d.warsztat) + " glowna";})
                      .attr("transform", function(d,i){return "translate(" + 0 + "," + (i*(heightBox + paddingBox)) + ")"});


  sesja_rano_grupy.append("rect")
                          .style("stroke", "black")
                          .attr("height", heightBox)
                          .attr("width",widthBox)
                          .style("fill", "none")
                          .attr("class", function(d){return podkreslString(d.warsztat) + " glowna";})
                          .style("stroke", function(d){ return skalaKolor(d.warsztat); })


    sesja_rano_grupy.append("a")
              .attr("xlink:href",function(d){return d.url;})
              .append("text")
              .attr("x", paddingRect)             
              .attr("y", paddingRect)
              .text(function(d){return d.warsztat;})
              .attr("dominant-baseline", "hanging")
              .attr("class", "warsztat_nazwa")


 var labelWiecej_rano = sesja_rano_grupy
                  .append("text")
                  .attr("x", widthBox - 4*paddingRect)             
                  .attr("y", paddingRect)
                  .text("więcej...")
                  .attr("dominant-baseline", "hanging")
                  .style("font-size","9px")
                  .style("stroke","none")
                  .style("fill","grey")

// zajetosc

var sesja_rano_zajetosc = sesja_rano_grupy.append("g")
                    .attr("class", "zajetosc")
                    .attr("transform","translate("+paddingRect+","+heightBox*6/10+")")

sesja_rano_zajetosc.append("text")
                    .text("popularność:")
                    .attr("dominant-baseline", "hanging")

  sesja_rano_zajetosc.append("text")
                    .attr("x", widthBox - 2*paddingRect)             
                    .text(function(d){
                            if(d.ile_rezerwa ==0){ return "";} 
                            else{
                              return "+"+d.ile_rezerwa;
                            }
                    })
                    .style("text-anchor", "end")
                    .attr("dominant-baseline", "hanging")


    sesja_rano_zajetosc.append("text")
                    .attr("x", widthBox - 2*paddingRect-20)             
                    .text(function(d){
                            return (d.ile-d.ile_rezerwa) + "/20"
                    })
                    .style("text-anchor", "end")
                    .attr("dominant-baseline", "hanging")


    sesja_rano_zajetosc.append("rect")
                          .attr("x", widthBox/4)             
                          .style("stroke", "black")
                          .style("stroke-width", "0.5px")
                          .attr("height", heightBox*1/5)
                          .attr("width",skalaZajete(20))
                          .style("fill", "#ebebe0")

    sesja_rano_zajetosc.append("rect")
                          .attr("x", widthBox/4)             
                          .style("stroke", "black")                          
                          .style("stroke-width", "0.5px")
                          .attr("height", heightBox*1/5)
                          .attr("width",function(d){   return skalaZajete(d.ile - d.ile_rezerwa);})
                          .style("fill", "#a7e3ef")  //#FFFF81

// statystyki




dodajStatystyki = function(sesja_grupy){

  var paddingSlupki = 5;

  var sesja_statystyki = sesja_grupy.append("g")
                    .attr("class", "statystyki")
                    .attr("transform", "translate("+paddingRect+","+(heightBox+paddingRect*3)+")")

// doswiadczenie w R

 var sesja_statystyki_doswR =   sesja_statystyki.append("g")           
                    .attr("class", "doswiadczenieR")


    sesja_statystyki_doswR
                    .append("rect")
                    .attr("x", function(d) {return widthBox/4 - skalaStatystyki(d.analizy_R_0_2);})          
                    .style("stroke", "black")
                    .style("stroke-width", "0.5px")
                    .attr("height", heightBox*1/5)
                    .attr("width",function(d) {return skalaStatystyki(d.analizy_R_0_2);})
                    .style("fill", "#a7e3ef")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)

    sesja_statystyki_doswR
                    .append("rect")
                    .attr("x",function(d) {return  widthBox/4 - skalaStatystyki(d.analizy_R_2_6);})  
                    .attr("y", heightBox/5+paddingSlupki)              
                    .style("stroke", "black")
                    .style("stroke-width", "0.5px")
                    .attr("height", heightBox*1/5)
                    .attr("width",function(d) {return skalaStatystyki(d.analizy_R_2_6);})
                    .style("fill", "#a7e3ef")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)

    sesja_statystyki_doswR
                    .append("rect")
                    .attr("x", function(d) {return widthBox/4-skalaStatystyki(d.analizy_R_6_wiecej);}) 
                     .attr("y", heightBox/5*2+paddingSlupki*2    )            
                    .style("stroke", "black")
                    .style("stroke-width", "0.5px")
                    .attr("height", heightBox*1/5)
                    .attr("width",function(d) {return skalaStatystyki(d.analizy_R_6_wiecej);})
                    .style("fill", "#a7e3ef")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)
// teksty

    sesja_statystyki_doswR
                    .append("text")
                    .attr("x", function(d) {return widthBox/4 - skalaStatystyki(d.analizy_R_0_2)-paddingRect;})              
                    .text(function(d){
                            return d3.round(d.analizy_R_0_2,0) +"%";
                            }
                    )
                    .style("text-anchor", "end")
                    .attr("dominant-baseline", "hanging")
                      .style("fill", "grey")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)


  sesja_statystyki_doswR
                    .append("text")
                    .attr("x", function(d) {return widthBox/4 - skalaStatystyki(d.analizy_R_2_6)-paddingRect;})    
                    .attr("y", heightBox/5+paddingSlupki)        
                    .text(function(d){
                            return d3.round(d.analizy_R_2_6,0) +"%";
                            }
                    )
                    .style("text-anchor", "end")
                    .attr("dominant-baseline", "hanging")
                      .style("fill", "grey")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)                       

 sesja_statystyki_doswR
                    .append("text")
                    .attr("x", function(d) {return widthBox/4 - skalaStatystyki(d.analizy_R_6_wiecej)-paddingRect;}) 
                    .attr("y", heightBox/5*2+paddingSlupki*2    )              
                    .text(function(d){
                            return d3.round(d.analizy_R_6_wiecej,0) +"%";
                            }
                    )
                    .style("text-anchor", "end")
                    .attr("dominant-baseline", "hanging")
                      .style("fill", "grey")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)
// labelki

sesja_statystyki.append("text")
                    .attr("x", widthBox/4 + paddingRect*3 )  
                    .attr("y", -paddingRect*2 )             
                    .text("podane doświadczenie w latach:" )
                    .style("text-anchor", "middle")
                    .attr("dominant-baseline", "hanging")
                      .style("fill", "grey")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)

sesja_statystyki.append("text")
                    .attr("x", widthBox/4 + paddingRect )           
                    .text("[0,2)")
                    .style("text-anchor", "start")
                    .attr("dominant-baseline", "hanging")
                      .style("fill", "grey")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)

sesja_statystyki.append("text")
                    .attr("x", widthBox/4 + paddingRect )   
                    .attr("y", heightBox/5+paddingSlupki)           
                    .text("[2,6)")
                    .style("text-anchor", "start")
                    .attr("dominant-baseline", "hanging")
                      .style("fill", "grey")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)

sesja_statystyki.append("text")
                    .attr("x", widthBox/4 + paddingRect )
                    .attr("y", heightBox/5*2+paddingSlupki*2)              
                    .text("6+")
                    .style("text-anchor", "start")
                    .attr("dominant-baseline", "hanging")
                      .style("fill", "grey")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)

sesja_statystyki.append("text")
                    .attr("x", widthBox/4 - paddingRect*4 )
                    .attr("y", heightBox/5*3+paddingSlupki*3)              
                    .text(" w R")
                    .style("text-anchor", "start")
                    .attr("dominant-baseline", "hanging")
                      .style("fill", "grey")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)

// doswiadczenie w analizach

 var sesja_statystyki_doswAnaliza =   sesja_statystyki.append("g")           
                    .attr("class", "doswiadczenieAnaliza")


    sesja_statystyki_doswAnaliza
                    .append("rect")
                    .attr("x", widthBox/4 + paddingRect*4)          
                    .style("stroke", "black")
                    .style("stroke-width", "0.5px")
                    .attr("height", heightBox*1/5)
                    .attr("width",function(d) {return skalaStatystyki(d.analizy_0_2);})
                    .style("fill", "#a7e3ef")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)

    sesja_statystyki_doswAnaliza
                    .append("rect")
                      .attr("x", widthBox/4 + paddingRect*4) 
                    .attr("y", heightBox/5+paddingSlupki)              
                    .style("stroke", "black")
                    .style("stroke-width", "0.5px")
                    .attr("height", heightBox*1/5)
                    .attr("width",function(d) {return skalaStatystyki(d.analizy_2_6);})
                    .style("fill", "#a7e3ef")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)

    sesja_statystyki_doswAnaliza
                    .append("rect")
                      .attr("x", widthBox/4 + paddingRect*4) 
                     .attr("y", heightBox/5*2+paddingSlupki*2  )            
                    .style("stroke", "black")
                    .style("stroke-width", "0.5px")
                    .attr("height", heightBox*1/5)
                    .attr("width",function(d) {return skalaStatystyki(d.analizy_6_wiecej);})
                    .style("fill", "#a7e3ef")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)
// teksty

    sesja_statystyki_doswAnaliza
                    .append("text")
                    .attr("x", function(d) {return widthBox/4 + paddingRect*4 + skalaStatystyki(d.analizy_0_2)+paddingRect;})              
                    .text(function(d){
                            return d3.round( d.analizy_0_2,0) +"%";
                            }
                    )
                    .style("text-anchor", "start")
                    .attr("dominant-baseline", "hanging")
                      .style("fill", "grey")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)


  sesja_statystyki_doswAnaliza
                    .append("text")
                    .attr("x", function(d) {return widthBox/4 + paddingRect*4 + skalaStatystyki(d.analizy_2_6)+paddingRect;})    
                    .attr("y", heightBox/5+paddingSlupki)        
                    .text(function(d){
                            return d3.round(d.analizy_2_6,0) +"%";
                            }
                    )
                    .style("text-anchor", "start")
                    .attr("dominant-baseline", "hanging")
                      .style("fill", "grey")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)                       

 sesja_statystyki_doswAnaliza 
                    .append("text")
                    .attr("x", function(d) {return widthBox/4 + paddingRect*4 + skalaStatystyki(d.analizy_6_wiecej)+paddingRect;}) 
                    .attr("y", heightBox/5*2+paddingSlupki*2    )              
                    .text(function(d){
                            return d3.round(d.analizy_6_wiecej,0) +"%";
                            }
                    )
                    .style("text-anchor", "start")
                    .attr("dominant-baseline", "hanging")
                      .style("fill", "grey")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)
// labelki

sesja_statystyki.append("text")
                    .attr("x", widthBox/4 + paddingRect*6 )
                    .attr("y", heightBox/5*3+paddingSlupki*3)              
                    .text(" w analizie danych")
                    .style("text-anchor", "start")
                    .attr("dominant-baseline", "hanging")
                      .style("fill", "grey")
                       .style("opacity", 0)
                        .transition()
                        .style("opacity", 1)


}


//******************************************************************** popoludnie
 
var sesja_popoludnie = g.append("g").attr("class", "warsztaty popoludnie")

 sesja_popoludnie.append("text")
              .attr("x", widthBox+paddingBlock+widthBox/2)             
              .attr("y", -paddingBox*2)
              .text("sesja popołudniowa")
              .style("text-anchor", "middle")
              .attr("class", "labelka")


var sesja_popoludnie_grupy = sesja_popoludnie.selectAll("g")
                      .data(dane
                        .filter(function(d){ return d.sesja == "sesja popoludniowa"; })
                        .sort(function(x, y){
                                       return d3.descending(x.ile, y.ile);
                                    }))
                      .enter()
                      .append("g")
                   .attr("class", function(d){return podkreslString(d.warsztat) + " glowna";})
                      .attr("transform", function(d,i){return "translate(" + (widthBox+paddingBlock)  + "," + (i*(heightBox + paddingBox)) + ")"});


    sesja_popoludnie_grupy.append("rect")
                          .style("stroke", "black")
                          .attr("height", heightBox)
                          .attr("width",widthBox)          
                          .style("fill", "none")
                          .attr("class", function(d){return podkreslString(d.warsztat) + " glowna";})


    sesja_popoludnie_grupy.append("a")
              .attr("xlink:href",function(d){return d.url;})
              .append("text")
              .attr("x", paddingRect)             
              .attr("y", paddingRect)
              .text(function(d){return d.warsztat;})
              .attr("dominant-baseline", "hanging")
              .attr("class", "warsztat_nazwa")

var sesja_popoludnie_zajetosc = sesja_popoludnie_grupy.append("g")
                    .attr("class", "zajetosc")
                    .attr("transform","translate("+paddingRect+","+heightBox*6/10+")")

sesja_popoludnie_zajetosc.append("text")
                    .text("popularność:")
                    .attr("dominant-baseline", "hanging")

  sesja_popoludnie_zajetosc.append("text")
                    .attr("x", widthBox - 2*paddingRect)             
                    .text(function(d){
                            if(d.ile_rezerwa ==0){ return "";} 
                            else{
                              return "+"+d.ile_rezerwa;
                            }
                    })
                    .style("text-anchor", "end")
                    .attr("dominant-baseline", "hanging")


    sesja_popoludnie_zajetosc.append("text")
                    .attr("x", widthBox - 2*paddingRect-20)             
                    .text(function(d){
                            return (d.ile-d.ile_rezerwa) + "/20"
                    })
                    .style("text-anchor", "end")
                    .attr("dominant-baseline", "hanging")


    sesja_popoludnie_zajetosc.append("rect")
                          .attr("x", widthBox/4)             
                          .style("stroke", "black")
                          .style("stroke-width", "0.5px")
                          .attr("height", heightBox*1/5)
                          .attr("width",skalaZajete(20))
                          .style("fill", "#ebebe0")

    sesja_popoludnie_zajetosc.append("rect")
                          .attr("x", widthBox/4)             
                          .style("stroke", "black")                          
                          .style("stroke-width", "0.5px")
                          .attr("height", heightBox*1/5)
                          .attr("width",function(d){   return skalaZajete(d.ile - d.ile_rezerwa);})
                          .style("fill", "#a7e3ef") //A7DBD8  #69D2E7

 var labelWiecej_popoludnie = sesja_popoludnie_grupy
                  .append("text")
                  .attr("x", widthBox - 4*paddingRect)             
                  .attr("y", paddingRect)
                  .text("więcej...")
                  .attr("dominant-baseline", "hanging")
                  .style("font-size","9px")
                  .style("stroke","none")
                  .style("fill","grey")

//**************************************************************************** tworzenie strzalek 

  var zwrocWspolrzedneTransformacji = function(element_g){

    if( element_g == null ){ return element_g;}
    else{
    var wspol = element_g.attr("transform").replace("translate(","");

        wspol = wspol.replace(")","")
        wspol = wspol.split(",")
        x =+ wspol[0]
        y =+ wspol[1]

        return [x,y];
      }
  }



  var rysujStrzalke = function(source, target) {

    var source_g = g.select("g." + podkreslString(source))
    var target_g = g.select("g." + podkreslString(target))

    var source_g_xy = zwrocWspolrzedneTransformacji(source_g);
    var target_g_xy = zwrocWspolrzedneTransformacji(target_g);

    var source_rect = g.select("rect." + podkreslString(source))
    var target_rect = g.select("rect." + podkreslString(target))

    var source_rect_wh =[ parseFloat(source_rect.attr("width")), parseFloat(source_rect.attr("height"))  ]
    var target_rect_wh =[ parseFloat(target_rect.attr("width")), parseFloat(target_rect.attr("height")) ]

    var curvature = .5,
         xl = source_g_xy[0] + source_rect_wh[0],
         xp = target_g_xy[0],
         xi = d3.interpolateNumber(xl, xp),
         x2 = xi(curvature),
         x3 = xi(1 - curvature),
         yl = source_g_xy[1] + source_rect_wh[1]/2  ,
         yp = target_g_xy[1] + target_rect_wh[1]/2;


    return "M" + xl + "," + yl  //x po lewej  y po lewej
           + "C" + x2 + "," + yl
           + " " + x3 + "," + yp
           + " " + xp + "," + yp; //x po prawej  y po prawej
    
  };

    



var strzalki = g.selectAll(".link")
                    .data(dane
                          .filter(function(d){ return d.sciezka != "brak"}))
                    .enter()
                    .append("path")
                    .attr("class", "link")
                    .attr("d", function(d){return rysujStrzalke(d.warsztat, d.sciezka);})
                    .style("stroke-width", "10px")
                    .style("stroke", function(d){ return skalaKolor(d.warsztat); })

//**************************************************************************** przycisk 


var przycisk = g.append("g").attr("id", "przycisk").attr("transform", "translate(" + (widthBox+(paddingBlock-120)/2)+ "," +(-paddingBox*5) + ")")
                  
    var przycisk_rect = przycisk.append("rect")
                          .style("stroke", "black")
                          .attr("height", 20)
                          .attr("width",120)          
                          .style("fill", "white")
                      

         przycisk.append("text")
                          .attr("x", paddingRect/2)             
                          .attr("y", paddingRect/2)
                          .text("Zwiń/Rozwiń statystyki")
                          .attr("dominant-baseline", "hanging")
                          .style("text-anchor", "start")
                          .style("pointer-events", "none")

var czyStat = false;

    przycisk_rect.on("click",function(d){

      var ile = 18;

      czyStat = !czyStat;
      if(czyStat){

        d3.select(this).style("stroke", "red");
        d3.selectAll(".warsztaty.rano g.glowna")
        .transition()
        .attr("transform",function(d,i){return "translate(" + 0+ ","  + (i*(heightBox2 + paddingBox))+")"}) 
        d3.selectAll(".warsztaty.popoludnie g.glowna")
        .transition()
        .attr("transform",function(d,i){return "translate(" + (widthBox+paddingBlock)+ ","  + (i*(heightBox2 + paddingBox))+")"}) 

        d3.selectAll(".warsztaty rect.glowna")
        .transition()
        .attr("height",heightBox2)
        .each("end", function() {        // <-- Executes at end of transition
                ile= ile-1;
                if(ile == 0){
                  
                      strzalki
                     .transition()
                      .attr("d", function(d){return rysujStrzalke(d.warsztat, d.sciezka);})
                }
             });


        dodajStatystyki(sesja_rano_grupy);
        dodajStatystyki(sesja_popoludnie_grupy);

          }

      if(!czyStat){
         
        d3.select(this).style("stroke", "black");
        d3.selectAll(".warsztaty.rano g.glowna")
        .transition()
        .attr("transform",function(d,i){return "translate(" + 0+ ","  + (i*(heightBox + paddingBox))+")"}) 
        d3.selectAll(".warsztaty.popoludnie g.glowna")
        .transition()
        .attr("transform",function(d,i){return "translate(" + (widthBox+paddingBlock)+ ","  + (i*(heightBox + paddingBox))+")"})

        d3.selectAll(".warsztaty rect.glowna")
        .transition()
        .attr("height",heightBox)
        .each("end", function() {        // <-- Executes at end of transition
                ile= ile-1;
                if(ile == 0){
                 
                      strzalki
                     .transition()
                      .attr("d", function(d){return rysujStrzalke(d.warsztat, d.sciezka);})
                }
             });

        g.selectAll(".statystyki").remove()

      }
    })

//********************************************************* TOOLTIPY



var tooltipki=d3.select("#chart1").append("div").attr("id", "tooltip").style("opacity",0)

labelWiecej_popoludnie
  .on("mouseover", function(d){


      tooltipki.html( "<b>" + "Zainteresowania" +"</b>" + "<br/>"+
          "1. "+ d.zaint1 + " " + d.zaint1_ile.toFixed(0)+ "%"  + "<br/>" +
          "2. "+ d.zaint2 + " " + d.zaint2_ile.toFixed(0)+ "%"  + "<br/>" +
          "3. "+ d.zaint3 + " " + d.zaint3_ile.toFixed(0)+ "%"  + "<br/>"
         


           )
      .style("left", (d3.event.pageX-widthBox+2*paddingRect ) + "px") /* ustalamy pozycje elementu tam gdzie zostanie akcja podjeta */
      .style("top", (d3.event.pageY+2*paddingRect) + "px")
      .transition()
      .duration(300)
      .style("opacity",1);
    


      }

    )
labelWiecej_popoludnie
.on("mouseout", function(d){


      tooltipki
      .transition()
      .duration(300)
      .style("opacity", 0);
              
 

      }
    );

labelWiecej_rano
  .on("mouseover", function(d){


      tooltipki.html( "<b>" + "Zainteresowania" +"</b>" + "<br/>"+
          "1. "+ d.zaint1 + " " + d.zaint1_ile.toFixed(0)+ "%"  + "<br/>" +
          "2. "+ d.zaint2 + " " + d.zaint2_ile.toFixed(0)+ "%"  + "<br/>" +
          "3. "+ d.zaint3 + " " + d.zaint3_ile.toFixed(0)+ "%"  + "<br/>"
           )
    .style("left", (d3.event.pageX-widthBox+2*paddingRect ) + "px") /* ustalamy pozycje elementu tam gdzie zostanie akcja podjeta */
      .style("top", (d3.event.pageY+2*paddingRect) + "px")
      .transition()
      .duration(300)
      .style("opacity",1);
    


      }

    )
labelWiecej_rano
.on("mouseout", function(d){


      tooltipki
      .transition()
      .duration(300)
      .style("opacity", 0);
              
 

      }
    );
}

</script>
</body>



</html>

